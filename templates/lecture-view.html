{% extends "base.html" %}

{% block head %}
<script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js" crossorigin="anonymous"></script>
<style>
    .transcript-segment.active {
        background-color: rgb(238, 242, 255);
        border-left: 3px solid rgb(99, 102, 241);
    }
    #waveform {
        background: rgb(249, 250, 251);
        border-radius: 0.5rem;
        padding: 1rem;
    }
    .time-marker {
        color: rgb(107, 114, 128);
        font-size: 0.875rem;
        font-weight: 500;
        min-width: 3rem;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .speed-option {
        transition: all 0.2s;
    }
    .speed-option:hover {
        background-color: rgb(238, 242, 255);
    }
    .speed-option.active {
        background-color: rgb(224, 231, 255);
        color: rgb(79, 70, 229);
    }
    .note {
        transition: all 0.2s;
    }
    .note:hover {
        transform: translateX(4px);
    }
    .aspect-w-16 {
        position: relative;
        padding-bottom: 56.25%;
    }
    .aspect-w-16 > * {
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
</style>

<!-- Initialize Tailwind Configuration -->
<script>
tailwind.config = {
    theme: {
        extend: {
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
            colors: {
                indigo: {
                    50: '#EEF2FF',
                    100: '#E0E7FF',
                    500: '#6366F1',
                    600: '#4F46E5',
                    700: '#4338CA',
                },
                gray: {
                    50: '#F9FAFB',
                    100: '#F3F4F6',
                    200: '#E5E7EB',
                    300: '#D1D5DB',
                    400: '#9CA3AF',
                    500: '#6B7280',
                    600: '#4B5563',
                    700: '#374151',
                    800: '#1F2937',
                    900: '#111827',
                },
            },
        },
    },
}
</script>
{% endblock %}

{% block content %}
<!-- Your existing HTML content here -->
{% endblock %}

{% block scripts %}
<script>
// Initialize WaveSurfer
const wavesurfer = WaveSurfer.create({
    container: '#waveform',
    waveColor: '#C7D2FE',
    progressColor: '#6366F1',
    cursorColor: '#4F46E5',
    barWidth: 2,
    barRadius: 3,
    cursorWidth: 1,
    height: 100,
    barGap: 2,
    responsive: true,
    normalize: true
})

// Load audio file
wavesurfer.load("{{ url_for('serve_file', filename=lecture.media_path) }}")

// Load transcript
fetch("{{ url_for('serve_file', filename=lecture.transcript_path) }}")
    .then(response => response.text())
    .then(text => {
        const transcriptContainer = document.getElementById('transcript')
        const lines = text.split('\n').filter(line => line.trim())
        
        lines.forEach((line, index) => {
            const [timestamp, ...textParts] = line.split(' ')
            const div = document.createElement('div')
            div.className = 'transcript-segment p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-150'
            div.innerHTML = `
                <div class="flex items-start">
                    <span class="time-marker">${timestamp}</span>
                    <p class="ml-3 text-gray-900">${textParts.join(' ')}</p>
                </div>
            `
            div.addEventListener('click', () => {
                const [minutes, seconds] = timestamp.split(':').map(Number)
                wavesurfer.setTime(minutes * 60 + seconds)
            })
            transcriptContainer.appendChild(div)
        })
    })
    .catch(error => {
        console.error('Error loading transcript:', error)
        document.getElementById('transcript').innerHTML = 'Error loading transcript'
    })

// UI Elements
const playPauseButton = document.getElementById('playPause')
const playPauseIcon = playPauseButton.querySelector('i')
const volumeBtn = document.getElementById('volume-btn')
const volumeInput = document.getElementById('volume')
const loadingStatus = document.getElementById('loading-status')
const errorMessage = document.getElementById('error-message')
const currentTimeDisplay = document.getElementById('current-time')
const totalDurationDisplay = document.getElementById('total-duration')

// Play/Pause functionality
playPauseButton.addEventListener('click', () => {
    wavesurfer.playPause()
})

// Previous/Next 10 seconds
document.getElementById('previous').addEventListener('click', () => {
    wavesurfer.skip(-10)
})

document.getElementById('next').addEventListener('click', () => {
    wavesurfer.skip(10)
})

// Volume control
volumeInput.addEventListener('input', (e) => {
    const volume = e.target.value / 100
    wavesurfer.setVolume(volume)
    updateVolumeIcon(volume)
})

volumeBtn.addEventListener('click', () => {
    const currentVolume = wavesurfer.getVolume()
    if (currentVolume > 0) {
        wavesurfer.setVolume(0)
        volumeInput.value = 0
    } else {
        wavesurfer.setVolume(1)
        volumeInput.value = 100
    }
    updateVolumeIcon(wavesurfer.getVolume())
})

// Playback speed control
function toggleSpeedMenu() {
    const menu = document.getElementById('speed-menu')
    menu.classList.toggle('hidden')
}

function setPlaybackSpeed(speed) {
    wavesurfer.setPlaybackRate(speed)
    document.getElementById('current-speed').textContent = speed + 'x'
    document.querySelectorAll('.speed-option').forEach(option => {
        option.classList.toggle('active', option.textContent === speed + 'x')
    })
    toggleSpeedMenu()
}

// Notes functionality
const notes = []
let noteIdCounter = 0

function addNote() {
    const currentTime = wavesurfer.getCurrentTime()
    const note = {
        id: noteIdCounter++,
        timestamp: currentTime,
        text: '',
        isEditing: true
    }
    notes.push(note)
    renderNotes()
}

function saveNote(id, text) {
    const note = notes.find(n => n.id === id)
    if (note) {
        note.text = text
        note.isEditing = false
        renderNotes()
    }
}

function deleteNote(id) {
    const index = notes.findIndex(n => n.id === id)
    if (index !== -1) {
        notes.splice(index, 1)
        renderNotes()
    }
}

function renderNotes() {
    const container = document.getElementById('notes-container')
    container.innerHTML = ''
    
    notes.sort((a, b) => a.timestamp - b.timestamp).forEach(note => {
        const div = document.createElement('div')
        div.className = 'note bg-gray-50 rounded-lg p-4'
        
        if (note.isEditing) {
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500">${formatTime(note.timestamp)}</span>
                    <button onclick="deleteNote(${note.id})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <textarea class="w-full p-2 border rounded-md" placeholder="Enter your note..."
                    onblur="saveNote(${note.id}, this.value)">${note.text}</textarea>
            `
        } else {
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500">${formatTime(note.timestamp)}</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="editNote(${note.id})" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteNote(${note.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p class="text-gray-700">${note.text}</p>
            `
        }
        container.appendChild(div)
    })
}

function editNote(id) {
    const note = notes.find(n => n.id === id)
    if (note) {
        note.isEditing = true
        renderNotes()
    }
}

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.tab-button').forEach(button => {
        const isActive = button.textContent.toLowerCase().includes(tabName)
        button.classList.toggle('border-indigo-500', isActive)
        button.classList.toggle('text-indigo-600', isActive)
        button.classList.toggle('border-transparent', !isActive)
        button.classList.toggle('text-gray-500', !isActive)
    })

    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${tabName}-tab`)
    })
}

// Share functionality
function showShareModal() {
    document.getElementById('share-modal').classList.remove('hidden')
}

function closeShareModal() {
    document.getElementById('share-modal').classList.add('hidden')
}

function copyShareLink() {
    const link = document.getElementById('share-link')
    link.select()
    document.execCommand('copy')
    alert('Link copied to clipboard!')
}

function copyTimestampLink() {
    const link = document.getElementById('timestamp-link')
    link.value = `${window.location.origin}${window.location.pathname}?t=${Math.floor(wavesurfer.getCurrentTime())}`
    link.select()
    document.execCommand('copy')
    alert('Link with timestamp copied to clipboard!')
}

// Download transcript
function downloadTranscript() {
    fetch("{{ url_for('serve_file', filename=lecture.transcript_path) }}")
        .then(response => response.text())
        .then(text => {
            const blob = new Blob([text], { type: 'text/plain' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = '{{ lecture.title }}-transcript.txt'
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            URL.revokeObjectURL(url)
        })
        .catch(error => {
            console.error('Error downloading transcript:', error)
            alert('Error downloading transcript')
        })
}

// WaveSurfer events
wavesurfer.on('ready', () => {
    loadingStatus.innerHTML = '<i class="fas fa-check-circle text-green-500"></i> Audio loaded'
    totalDurationDisplay.textContent = formatTime(wavesurfer.getDuration())
    errorMessage.classList.add('hidden')
    
    // Check for timestamp in URL
    const urlParams = new URLSearchParams(window.location.search)
    const timestamp = urlParams.get('t')
    if (timestamp) {
        wavesurfer.setTime(parseInt(timestamp))
    }
})

wavesurfer.on('error', (err) => {
    console.error('WaveSurfer error:', err)
    loadingStatus.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i> Error loading audio'
    errorMessage.classList.remove('hidden')
})

wavesurfer.on('play', () => {
    playPauseIcon.className = 'fas fa-pause'
})

wavesurfer.on('pause', () => {
    playPauseIcon.className = 'fas fa-play'
})

wavesurfer.on('audioprocess', () => {
    const currentTime = wavesurfer.getCurrentTime()
    currentTimeDisplay.textContent = formatTime(currentTime)
    
    // Update active transcript segment
    document.querySelectorAll('.transcript-segment').forEach(segment => {
        const timeMarker = segment.querySelector('.time-marker').textContent
        const [minutes, seconds] = timeMarker.split(':').map(Number)
        const segmentTime = minutes * 60 + seconds
        
        if (Math.abs(currentTime - segmentTime) < 1) {
            segment.classList.add('active')
            segment.scrollIntoView({ behavior: 'smooth', block: 'nearest' })
        } else {
            segment.classList.remove('active')
        }
    })
})

// Helper functions
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60)
    const remainingSeconds = Math.floor(seconds % 60)
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`
}

function updateVolumeIcon(volume) {
    const icon = volumeBtn.querySelector('i')
    icon.className = volume === 0 
        ? 'fas fa-volume-mute' 
        : volume < 0.5 
            ? 'fas fa-volume-down' 
            : 'fas fa-volume-up'
}

// Close modals when clicking outside
window.addEventListener('click', (e) => {
    const shareModal = document.getElementById('share-modal')
    if (e.target === shareModal) {
        closeShareModal()
    }
})

// Close modals and menus on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeShareModal()
        document.getElementById('speed-menu').classList.add('hidden')
    }
})
</script>
{% endblock %}
